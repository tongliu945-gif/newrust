name: Build Android APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.24.5"
  RUST_TOOLCHAIN: "stable"
  CARGO_NDK_VERSION: "3.5.4"
  NDK_VERSION: "r27c"
  ANDROID_API: "34"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }}

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true

      - name: Set NDK environment
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            libclang-dev \
            llvm-dev \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev \
            protobuf-compiler \
            nasm \
            yasm
          # Find and export libclang path for bindgen
          LLVM_CONFIG=$(which llvm-config || which llvm-config-14 || which llvm-config-15 || which llvm-config-16)
          if [ -n "$LLVM_CONFIG" ]; then
            echo "LIBCLANG_PATH=$($LLVM_CONFIG --libdir)" >> $GITHUB_ENV
          fi

      - name: Setup vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git $HOME/vcpkg
          cd $HOME/vcpkg
          ./bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV

      - name: Build vcpkg dependencies (arm64)
        run: |
          export ANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }}
          export VCPKG_ROOT=$HOME/vcpkg
          # Run vcpkg install from project root where vcpkg.json is located
          cd $GITHUB_WORKSPACE
          echo "=== vcpkg.json content ==="
          cat vcpkg.json
          echo "=== Installing vcpkg packages ==="
          $VCPKG_ROOT/vcpkg install --triplet arm64-android --x-install-root="$VCPKG_ROOT/installed" --overlay-ports=res/vcpkg
          echo "=== Verifying installed files ==="
          ls -la $VCPKG_ROOT/installed/arm64-android/include/ || echo "Include dir not found"
          ls -la $VCPKG_ROOT/installed/arm64-android/include/opus/ || echo "Opus include dir not found"
          ls -la $VCPKG_ROOT/installed/arm64-android/lib/ || echo "Lib dir not found"
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Build vcpkg dependencies (arm-neon)
        run: |
          export ANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }}
          export VCPKG_ROOT=$HOME/vcpkg
          # Run vcpkg install from project root where vcpkg.json is located
          cd $GITHUB_WORKSPACE
          $VCPKG_ROOT/vcpkg install --triplet arm-neon-android --x-install-root="$VCPKG_ROOT/installed" --overlay-ports=res/vcpkg
          # Move arm-neon-android to arm-android as expected by cargo
          if [ -d "$VCPKG_ROOT/installed/arm-neon-android" ]; then
            mv "$VCPKG_ROOT/installed/arm-neon-android" "$VCPKG_ROOT/installed/arm-android"
          fi
          echo "=== Verifying arm-android installed files ==="
          ls -la $VCPKG_ROOT/installed/arm-android/include/ || echo "Include dir not found"
          ls -la $VCPKG_ROOT/installed/arm-android/include/opus/ || echo "Opus include dir not found"
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-android-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup signing key
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "使用 release 签名密钥..."
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > flutter/android/release.jks
            echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > flutter/android/key.properties
            echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> flutter/android/key.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> flutter/android/key.properties
            echo "storeFile=../release.jks" >> flutter/android/key.properties
          else
            echo "未配置签名密钥，使用 debug 签名..."
            keytool -genkey -v -keystore flutter/android/debug.jks \
              -storepass android -alias androiddebugkey -keypass android \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US" -noprompt
            echo "storePassword=android" > flutter/android/key.properties
            echo "keyPassword=android" >> flutter/android/key.properties
            echo "keyAlias=androiddebugkey" >> flutter/android/key.properties
            echo "storeFile=../debug.jks" >> flutter/android/key.properties
          fi

      - name: Build Rust library for Android (arm64)
        run: |
          NDK=${{ steps.setup-ndk.outputs.ndk-path }}
          TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
          SYSROOT=$TOOLCHAIN/sysroot
          VCPKG_INCLUDE=$HOME/vcpkg/installed/arm64-android/include
          
          echo "=== Debug: Checking include paths ==="
          echo "VCPKG_INCLUDE: $VCPKG_INCLUDE"
          ls -la $VCPKG_INCLUDE/opus/ || echo "Opus headers not found!"
          echo "LIBCLANG_PATH: $LIBCLANG_PATH"
          
          # Set cross-compiler for ring and other C code
          export CC_aarch64_linux_android="$TOOLCHAIN/bin/aarch64-linux-android21-clang"
          export CXX_aarch64_linux_android="$TOOLCHAIN/bin/aarch64-linux-android21-clang++"
          export AR_aarch64_linux_android="$TOOLCHAIN/bin/llvm-ar"
          export RANLIB_aarch64_linux_android="$TOOLCHAIN/bin/llvm-ranlib"
          
          # Set clang target for Android aarch64 and include paths
          # LIBCLANG_PATH is set globally from Install dependencies step
          export BINDGEN_EXTRA_CLANG_ARGS="--target=aarch64-linux-android21 --sysroot=$SYSROOT -I$VCPKG_INCLUDE -I$SYSROOT/usr/include -I$SYSROOT/usr/include/aarch64-linux-android"
          export CFLAGS_aarch64_linux_android="--sysroot=$SYSROOT -I$VCPKG_INCLUDE"
          export CXXFLAGS_aarch64_linux_android="--sysroot=$SYSROOT -I$VCPKG_INCLUDE"
          # Additional include path for clang
          export C_INCLUDE_PATH="$VCPKG_INCLUDE:$SYSROOT/usr/include"
          export CPLUS_INCLUDE_PATH="$VCPKG_INCLUDE:$SYSROOT/usr/include"
          
          echo "CC_aarch64_linux_android: $CC_aarch64_linux_android"
          echo "BINDGEN_EXTRA_CLANG_ARGS: $BINDGEN_EXTRA_CLANG_ARGS"
          
          cargo ndk -t arm64-v8a -o flutter/android/app/src/main/jniLibs build --release --features flutter
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          VCPKG_ROOT: /home/runner/vcpkg

      - name: Build Rust library for Android (armeabi-v7a)
        run: |
          NDK=${{ steps.setup-ndk.outputs.ndk-path }}
          TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
          SYSROOT=$TOOLCHAIN/sysroot
          VCPKG_INCLUDE=$HOME/vcpkg/installed/arm-android/include
          
          # Set cross-compiler for ring and other C code
          export CC_armv7_linux_androideabi="$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang"
          export CXX_armv7_linux_androideabi="$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++"
          export AR_armv7_linux_androideabi="$TOOLCHAIN/bin/llvm-ar"
          export RANLIB_armv7_linux_androideabi="$TOOLCHAIN/bin/llvm-ranlib"
          
          # Set clang target for Android armv7 and include paths
          # LIBCLANG_PATH is set globally from Install dependencies step
          export BINDGEN_EXTRA_CLANG_ARGS="--target=armv7a-linux-androideabi21 --sysroot=$SYSROOT -I$VCPKG_INCLUDE -I$SYSROOT/usr/include -I$SYSROOT/usr/include/arm-linux-androideabi"
          export CFLAGS_armv7_linux_androideabi="--sysroot=$SYSROOT -I$VCPKG_INCLUDE"
          export CXXFLAGS_armv7_linux_androideabi="--sysroot=$SYSROOT -I$VCPKG_INCLUDE"
          # Additional include path for clang
          export C_INCLUDE_PATH="$VCPKG_INCLUDE:$SYSROOT/usr/include"
          export CPLUS_INCLUDE_PATH="$VCPKG_INCLUDE:$SYSROOT/usr/include"
          
          cargo ndk -t armeabi-v7a -o flutter/android/app/src/main/jniLibs build --release --features flutter
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          VCPKG_ROOT: /home/runner/vcpkg

      - name: Flutter pub get
        run: |
          cd flutter
          flutter pub get

      - name: Build APK
        run: |
          cd flutter
          flutter build apk --release

      - name: Build App Bundle
        run: |
          cd flutter
          flutter build appbundle --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-apk
          path: flutter/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-aab
          path: flutter/build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            flutter/build/app/outputs/flutter-apk/app-release.apk
            flutter/build/app/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
