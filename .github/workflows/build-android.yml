name: Build Custom Android APK

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      upload-artifact:
        description: 'Upload Artifact'
        type: boolean
        default: true
  
  # 推送到main分支时触发
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  build-android-apk:
    name: Build Android APK (arm64-v8a)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 25.1.8937393
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-linux-android
      
      - name: Install cargo-ndk
        run: cargo install cargo-ndk
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
      
      - name: Disable Flutter analytics
        run: flutter config --no-analytics
          
      - name: Get Flutter dependencies
        run: |
          cd flutter
          flutter pub get 2>&1 | tee pub_get.log
          echo "Dependencies fetched successfully"
        continue-on-error: false
      
      - name: Setup vcpkg with Github Actions binary cache
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: /opt/vcpkg
          vcpkgGitCommitId: '120deac3062162151622ca4860575a33844ba10b'
          doNotCache: false
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm yasm
      
      - name: Install vcpkg dependencies for Android
        run: |
          export VCPKG_ROOT=/opt/vcpkg
          export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
          export ANDROID_NDK=$ANDROID_NDK_ROOT
          
          # 在项目根目录安装 vcpkg 依赖（读取 vcpkg.json）
          $VCPKG_ROOT/vcpkg install --triplet arm64-android --x-install-root="$VCPKG_ROOT/installed"
          
          # 列出已安装的包
          echo "=== Installed libs ==="
          ls -la $VCPKG_ROOT/installed/arm64-android/lib/ || true
          echo "=== Installed includes ==="
          ls -la $VCPKG_ROOT/installed/arm64-android/include/ || true
        env:
          VCPKG_ROOT: /opt/vcpkg
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_ROOT }}
          ANDROID_NDK: ${{ env.ANDROID_NDK_ROOT }}
      
      - name: Build Rust library for Android
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_ROOT }}
          VCPKG_ROOT: /opt/vcpkg
        run: |
          export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:${PATH}"
          export VCPKG_ROOT=/opt/vcpkg
          
          # 编译 Rust 库 (arm64)
          cargo ndk --platform 21 --target aarch64-linux-android build --release --features "flutter,use_dasp"
          
          # 复制库文件到 jniLibs
          mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
          cp target/aarch64-linux-android/release/liblibrustdesk.so flutter/android/app/src/main/jniLibs/arm64-v8a/
      
      - name: Build Flutter APK
        run: |
          cd flutter
          flutter build apk --release --target-platform android-arm64
      
      - name: Rename APK
        run: |
          cd flutter/build/app/outputs/flutter-apk
          VERSION=$(grep "version:" ../../../pubspec.yaml | awk '{print $2}' | tr -d "'")
          mv app-release.apk rustdesk-custom-${VERSION}-arm64-v8a.apk || mv app-release.apk rustdesk-custom-arm64-v8a.apk
      
      - name: Upload APK
        if: ${{ github.event.inputs.upload-artifact == 'true' || github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-custom-android-apk
          path: flutter/build/app/outputs/flutter-apk/*.apk
      
      - name: Create Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: flutter/build/app/outputs/flutter-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

